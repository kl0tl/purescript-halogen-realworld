// Generated by purs version 0.13.6
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Category from "../Control.Category/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Aff_AVar from "../Effect.Aff.AVar/index.js";
import * as Effect_Aff_Class from "../Effect.Aff.Class/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Exception from "../Effect.Exception/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Formless_Types_Component from "../Formless.Types.Component/index.js";
import * as Halogen_Query_HalogenM from "../Halogen.Query.HalogenM/index.js";
var debounceForm = function (dictMonadAff) {
    return function (ms) {
        return function (pre) {
            return function (post) {
                return function (last) {
                    var readRef = function (dictMonadAff1) {
                        var $2126 = Effect_Class.liftEffect(dictMonadAff1.MonadEffect0());
                        var $2127 = Data_Functor.map(Effect.functorEffect)(Control_Bind.join(Data_Maybe.bindMaybe));
                        var $2128 = Data_Traversable.traverse(Data_Traversable.traversableMaybe)(Effect.applicativeEffect)(Effect_Ref.read);
                        return function ($2129) {
                            return $2126($2127($2128($2129)));
                        };
                    };
                    var mkFiber = function (v) {
                        return Effect_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff))(Effect_Aff.forkAff(Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff)(Effect_Aff.delay(ms))(function ($dollar__unused) {
                            return Effect_Aff_AVar.put(Data_Unit.unit)(v);
                        })));
                    };
                    var killFiber$prime = function (dictMonadAff1) {
                        var $2130 = Effect_Aff_Class.liftAff(dictMonadAff1);
                        var $2131 = Effect_Aff.killFiber(Effect_Exception.error("time's up!"));
                        return function ($2132) {
                            return $2130($2131($2132));
                        };
                    };
                    var atomic = function (dictMonadAff1) {
                        return function (process) {
                            return function (maybeLast) {
                                return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.get(Halogen_Query_HalogenM.monadStateHalogenM))(function (state) {
                                    var ref = (Data_Newtype.unwrap(Formless_Types_Component.newtypeInternalState)(state.internal)).validationRef;
                                    return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(readRef(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff1))(ref))(function (mbRef) {
                                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Data_Foldable.for_(Halogen_Query_HalogenM.applicativeHalogenM)(Data_Foldable.foldableMaybe)(mbRef)(Halogen_Query_HalogenM.kill))(function ($dollar__unused) {
                                            return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff1.MonadEffect0()))(Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe)(ref)(Effect_Ref.write(Data_Maybe.Nothing.value))))(function ($dollar__unused) {
                                                return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Halogen_Query_HalogenM.fork(Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(process)(function (form) {
                                                    return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.modify_(Halogen_Query_HalogenM.monadStateHalogenM)(function (v) {
                                                        var $2121 = {};
                                                        for (var $2122 in v) {
                                                            if ({}.hasOwnProperty.call(v, $2122)) {
                                                                $2121[$2122] = v[$2122];
                                                            };
                                                        };
                                                        $2121.form = form;
                                                        return $2121;
                                                    }))(function ($dollar__unused) {
                                                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff1.MonadEffect0()))(Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe)(ref)(Effect_Ref.write(Data_Maybe.Nothing.value))))(function ($dollar__unused) {
                                                            return Data_Foldable.for_(Halogen_Query_HalogenM.applicativeHalogenM)(Data_Foldable.foldableMaybe)(maybeLast)(Control_Category.identity(Control_Category.categoryFn));
                                                        });
                                                    });
                                                })))(function (forkId) {
                                                    return Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff1.MonadEffect0()))(Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe)(ref)(Effect_Ref.write(new Data_Maybe.Just(forkId))));
                                                });
                                            });
                                        });
                                    });
                                });
                            };
                        };
                    };
                    var processAfterDelay = function ($$var) {
                        return function (dbRef) {
                            return Halogen_Query_HalogenM.fork(Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Data_Functor["void"](Halogen_Query_HalogenM.functorHalogenM)(Effect_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff))(Effect_Aff_AVar.take($$var))))(function ($dollar__unused) {
                                return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0()))(Data_Foldable.traverse_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe)(Effect_Ref.write(Data_Maybe.Nothing.value))(dbRef)))(function ($dollar__unused) {
                                    return atomic(dictMonadAff)(post)(new Data_Maybe.Just(last));
                                });
                            }));
                        };
                    };
                    return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.get(Halogen_Query_HalogenM.monadStateHalogenM))(function (state) {
                        var vdRef = (Data_Newtype.unwrap(Formless_Types_Component.newtypeInternalState)(state.internal)).validationRef;
                        var dbRef = (Data_Newtype.unwrap(Formless_Types_Component.newtypeInternalState)(state.internal)).debounceRef;
                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(readRef(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff))(vdRef))(Data_Foldable.traverse_(Halogen_Query_HalogenM.applicativeHalogenM)(Data_Foldable.foldableMaybe)(Halogen_Query_HalogenM.kill)))(function ($dollar__unused) {
                            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0()))(Data_Functor.map(Effect.functorEffect)(Control_Bind.join(Data_Maybe.bindMaybe))(Data_Traversable.traverse(Data_Traversable.traversableMaybe)(Effect.applicativeEffect)(Effect_Ref.read)(dbRef))))(function (debouncer) {
                                if (debouncer instanceof Data_Maybe.Nothing) {
                                    return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Effect_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff))(Effect_Aff_AVar.empty))(function ($$var) {
                                        return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(mkFiber($$var))(function (fiber) {
                                            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(processAfterDelay($$var)(dbRef))(function (forkId) {
                                                return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0()))(Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe)(dbRef)(Effect_Ref.write(new Data_Maybe.Just({
                                                    "var": $$var,
                                                    fiber: fiber,
                                                    forkId: forkId
                                                })))))(function ($dollar__unused) {
                                                    return atomic(dictMonadAff)(pre)(Data_Maybe.Nothing.value);
                                                });
                                            });
                                        });
                                    });
                                };
                                if (debouncer instanceof Data_Maybe.Just) {
                                    return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Data_Functor["void"](Halogen_Query_HalogenM.functorHalogenM)(killFiber$prime(Halogen_Query_HalogenM.monadAffHalogenM(dictMonadAff))(debouncer.value0.fiber)))(function ($dollar__unused) {
                                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Data_Functor["void"](Halogen_Query_HalogenM.functorHalogenM)(Halogen_Query_HalogenM.kill(debouncer.value0.forkId)))(function ($dollar__unused) {
                                            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(mkFiber(debouncer["value0"]["var"]))(function (fiber) {
                                                return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(processAfterDelay(debouncer["value0"]["var"])(dbRef))(function (forkId) {
                                                    return Effect_Class.liftEffect(Halogen_Query_HalogenM.monadEffectHalogenM(dictMonadAff.MonadEffect0()))(Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe)(dbRef)(Effect_Ref.write(new Data_Maybe.Just({
                                                        "var": debouncer["value0"]["var"],
                                                        fiber: fiber,
                                                        forkId: forkId
                                                    }))));
                                                });
                                            });
                                        });
                                    });
                                };
                                throw new Error("Failed pattern match at Formless.Internal.Debounce (line 41, column 3 - line 58, column 74): " + [ debouncer.constructor.name ]);
                            });
                        });
                    });
                };
            };
        };
    };
};
export {
    debounceForm
};
