// Generated by purs version 0.13.8
"use strict";
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Monad_Rec_Class = require("../Control.Monad.Rec.Class/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_List_Types = require("../Data.List.Types/index.js");
var Data_Monoid = require("../Data.Monoid/index.js");
var Effect = require("../Effect/index.js");
var Effect_AVar = require("../Effect.AVar/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Effect_Aff_AVar = require("../Effect.Aff.AVar/index.js");
var Effect_Class = require("../Effect.Class/index.js");
var Bus = (function () {
    function Bus(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    Bus.create = function (value0) {
        return function (value1) {
            return new Bus(value0, value1);
        };
    };
    return Bus;
})();
var write = function (a) {
    return function (v) {
        return Effect_Aff_AVar.put(a)(v.value0);
    };
};
var read = function (v) {
    return Control_Bind.bind(Effect_Aff.bindAff)(Effect_Aff_AVar.empty)(function (res$prime) {
        return Control_Bind.bind(Effect_Aff.bindAff)(Effect_Aff_AVar.take(v.value1))(function (cs) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff)(Effect_Aff_AVar.put(new Data_List_Types.Cons(res$prime, cs))(v.value1))(function ($dollar__unused) {
                return Effect_Aff_AVar.take(res$prime);
            });
        });
    });
};
var make = function (dictMonadEffect) {
    return Effect_Class.liftEffect(dictMonadEffect)(function __do() {
        var cell = Effect_AVar.empty();
        var consumers = Effect_AVar["new"](Data_Monoid.mempty(Data_List_Types.monoidList))();
        return Control_Bind.discard(Control_Bind.discardUnit)(Effect.bindEffect)(Effect_Aff.launchAff_(Effect_Aff.attempt(Control_Monad_Rec_Class.forever(Effect_Aff.monadRecAff)(Control_Bind.bind(Effect_Aff.bindAff)(Effect_Aff_AVar.take(cell))(function (res) {
            return Control_Bind.bind(Effect_Aff.bindAff)(Effect_Aff_AVar.take(consumers))(function (vars) {
                return Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff)(Effect_Aff_AVar.put(Data_List_Types.Nil.value)(consumers))(function ($dollar__unused) {
                    return Data_Foldable.sequence_(Effect_Aff.applicativeAff)(Data_List_Types.foldableList)(Data_Foldable.foldl(Data_List_Types.foldableList)(function (xs) {
                        return function (a) {
                            return new Data_List_Types.Cons(Effect_Aff_AVar.put(res)(a), xs);
                        };
                    })(Data_Monoid.mempty(Data_List_Types.monoidList))(vars));
                });
            });
        })))))(function ($dollar__unused) {
            return Control_Applicative.pure(Effect.applicativeEffect)(new Bus(cell, consumers));
        })();
    });
};
module.exports = {
    make: make,
    read: read,
    write: write
};
