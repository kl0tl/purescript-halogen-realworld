// Generated by purs version 0.13.8
"use strict";
var Affjax = require("../Affjax/index.js");
var Conduit_Api_Endpoint = require("../Conduit.Api.Endpoint/index.js");
var Conduit_Api_Request = require("../Conduit.Api.Request/index.js");
var Conduit_AppM = require("../Conduit.AppM/index.js");
var Conduit_Component_Router = require("../Conduit.Component.Router/index.js");
var Conduit_Data_Avatar = require("../Conduit.Data.Avatar/index.js");
var Conduit_Data_Route = require("../Conduit.Data.Route/index.js");
var Conduit_Data_Username = require("../Conduit.Data.Username/index.js");
var Conduit_Data_Utils = require("../Conduit.Data.Utils/index.js");
var Conduit_Env = require("../Conduit.Env/index.js");
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Data_Argonaut_Decode_Class = require("../Data.Argonaut.Decode.Class/index.js");
var Data_Argonaut_Decode_Struct_Tolerant_DecodeJson = require("../Data.Argonaut.Decode.Struct.Tolerant.DecodeJson/index.js");
var Data_Argonaut_Decode_Struct_Tolerant_GDecodeJson = require("../Data.Argonaut.Decode.Struct.Tolerant.GDecodeJson/index.js");
var Data_Bifunctor = require("../Data.Bifunctor/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Eq = require("../Data.Eq/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Operator_Top = require("../Data.Operator.Top/index.js");
var Data_Struct_Insert_RInsert = require("../Data.Struct.Insert.RInsert/index.js");
var Data_Symbol = require("../Data.Symbol/index.js");
var Data_Unit = require("../Data.Unit/index.js");
var Effect = require("../Effect/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Effect_Aff_Bus = require("../Effect.Aff.Bus/index.js");
var Effect_Aff_Class = require("../Effect.Aff.Class/index.js");
var Effect_Class = require("../Effect.Class/index.js");
var Effect_Ref = require("../Effect.Ref/index.js");
var Halogen_Aff_Util = require("../Halogen.Aff.Util/index.js");
var Halogen_Component = require("../Halogen.Component/index.js");
var Halogen_HTML_Core = require("../Halogen.HTML.Core/index.js");
var Halogen_Query = require("../Halogen.Query/index.js");
var Halogen_VDom_Driver = require("../Halogen.VDom.Driver/index.js");
var Record_Builder = require("../Record.Builder/index.js");
var Routing_Duplex = require("../Routing.Duplex/index.js");
var Routing_Hash = require("../Routing.Hash/index.js");
var Type_Equality = require("../Type.Equality/index.js");
var Type_Proxying_Symbol = require("../Type.Proxying.Symbol/index.js");
var main = Halogen_Aff_Util.runHalogenAff(Control_Bind.bind(Effect_Aff.bindAff)(Halogen_Aff_Util.awaitBody)(function (body) {
    return Control_Bind.bind(Effect_Aff.bindAff)(Effect_Class.liftEffect(Effect_Aff.monadEffectAff)(Effect_Ref["new"](Data_Maybe.Nothing.value)))(function (currentUser) {
        return Control_Bind.bind(Effect_Aff.bindAff)(Effect_Class.liftEffect(Effect_Aff.monadEffectAff)(Effect_Aff_Bus.make(Effect_Class.monadEffectEffect)))(function (userBus) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff)(Control_Bind.bind(Effect_Aff.bindAff)(Effect_Class.liftEffect(Effect_Aff.monadEffectAff)(Conduit_Api_Request.readToken))(Data_Foldable.traverse_(Effect_Aff.applicativeAff)(Data_Foldable.foldableMaybe)(function (token) {
                var requestOptions = {
                    endpoint: Conduit_Api_Endpoint.User.value,
                    method: Conduit_Api_Request.Get.value
                };
                return Control_Bind.bind(Effect_Aff.bindAff)(Effect_Aff_Class.liftAff(Effect_Aff_Class.monadAffAff)(Affjax.request(Conduit_Api_Request.defaultRequest("https://conduit.productionready.io")(new Data_Maybe.Just(token))(requestOptions))))(function (res) {
                    var u = Control_Bind.bindFlipped(Data_Either.bindEither)(Conduit_Data_Utils.decodeAt(Data_Argonaut_Decode_Struct_Tolerant_DecodeJson.decodeJsonRecord(Data_Argonaut_Decode_Struct_Tolerant_GDecodeJson.gDecodeJson_ConsNilCons_Plus()(Data_Argonaut_Decode_Class.decodeJsonMaybe(Data_Argonaut_Decode_Class.decodeJsonString))(Data_Argonaut_Decode_Struct_Tolerant_GDecodeJson.gDecodeJson_ConsNilCons_Plus()(Data_Argonaut_Decode_Class.decodeJsonMaybe(Conduit_Data_Avatar.decodeJsonAvatar))(Data_Argonaut_Decode_Struct_Tolerant_GDecodeJson.gDecodeJson_ConsNilCons_nonPlus()(Conduit_Data_Username.decodeJsonUsername)(Data_Argonaut_Decode_Struct_Tolerant_GDecodeJson.gDecodeJson_NilNilNil(Record_Builder.categoryBuilder)(Data_Operator_Top.top1_Either))(new Data_Symbol.IsSymbol(function ($dollar__unused) {
                        return "username";
                    }))()(Data_Struct_Insert_RInsert.rinsertBuilder(new Data_Symbol.IsSymbol(function ($dollar__unused) {
                        return "username";
                    }))(Type_Proxying_Symbol.sProxyingSProxy))(Record_Builder.semigroupoidBuilder))(new Data_Symbol.IsSymbol(function ($dollar__unused) {
                        return "image";
                    }))()(Data_Maybe.plusMaybe)(Data_Struct_Insert_RInsert.rinsertBuilder(new Data_Symbol.IsSymbol(function ($dollar__unused) {
                        return "image";
                    }))(Type_Proxying_Symbol.sProxyingSProxy))(Record_Builder.semigroupoidBuilder))(new Data_Symbol.IsSymbol(function ($dollar__unused) {
                        return "bio";
                    }))()(Data_Maybe.plusMaybe)(Data_Struct_Insert_RInsert.rinsertBuilder(new Data_Symbol.IsSymbol(function ($dollar__unused) {
                        return "bio";
                    }))(Type_Proxying_Symbol.sProxyingSProxy))(Record_Builder.semigroupoidBuilder))())("user"))(Data_Bifunctor.bimap(Data_Either.bifunctorEither)(Affjax.printError)(function (v) {
                        return v.body;
                    })(res));
                    return Effect_Class.liftEffect(Effect_Aff.monadEffectAff)(Effect_Ref.write(Data_Either.hush(u))(currentUser));
                });
            })))(function ($dollar__unused) {
                var environment = (function () {
                    var userEnv = {
                        currentUser: currentUser,
                        userBus: userBus
                    };
                    return {
                        baseUrl: "https://conduit.productionready.io",
                        logLevel: Conduit_Env.Dev.value,
                        userEnv: userEnv
                    };
                })();
                var rootComponent = Halogen_Component.hoist(Halogen_HTML_Core.bifunctorHTML)(Effect_Aff.functorAff)(Conduit_AppM.runAppM(environment))(Conduit_Component_Router.component(Conduit_AppM.monadAffAppM)(Conduit_AppM.monadAskAppM(Type_Equality.refl))(Conduit_AppM.nowAppM)(Conduit_AppM.logMessagesAppM)(Conduit_AppM.navigateAppM)(Conduit_AppM.manageUserAppM)(Conduit_AppM.manageArticleAppM)(Conduit_AppM.manageCommentAppM)(Conduit_AppM.manageTagAppM));
                return Control_Bind.bind(Effect_Aff.bindAff)(Halogen_VDom_Driver.runUI(rootComponent)({})(body))(function (halogenIO) {
                    return Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff)(Data_Functor["void"](Effect_Aff.functorAff)(Effect_Class.liftEffect(Effect_Aff.monadEffectAff)(Routing_Hash.matchesWith(Data_Either.foldableEither)(Routing_Duplex.parse(Conduit_Data_Route.routeCodec))(function (old) {
                        return function ($$new) {
                            return Control_Applicative.when(Effect.applicativeEffect)(Data_Eq.notEq(Data_Maybe.eqMaybe(Conduit_Data_Route.eqRoute))(old)(new Data_Maybe.Just($$new)))(Effect_Aff.launchAff_(halogenIO.query(Halogen_Query.tell(Conduit_Component_Router.Navigate.create($$new)))));
                        };
                    }))))(function ($dollar__unused) {
                        return Control_Applicative.pure(Effect_Aff.applicativeAff)(Data_Unit.unit);
                    });
                });
            });
        });
    });
}));
module.exports = {
    main: main
};
